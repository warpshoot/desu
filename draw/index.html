<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>DESU‚Ñ¢ draw</title>
    <meta name="theme-color" content="#ffffff">
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="css/style.css">
    <script src="/desu/favicon.js"></script>
</head>

<body class="light">
    <!-- „Ç≠„É£„É≥„Éê„ÇπÁôΩËÉåÊôØ -->
    <div id="canvas-background"></div>

    <!-- ÂãïÁöÑ„É¨„Ç§„É§„Éº„Ç≥„É≥„ÉÜ„Éä (canvasË¶ÅÁ¥†„ÅØJS„ÅßËøΩÂä†„Åï„Çå„Çã) -->
    <div id="layer-container"></div>

    <!-- Êäï„ÅíÁ∏ÑÊèèÁîªÁî® -->
    <canvas id="lasso-canvas"></canvas>

    <!-- ‰øùÂ≠òÁØÑÂõ≤ÈÅ∏ÊäûÁî® -->
    <canvas id="selection-canvas" style="display:none;"></canvas>

    <!-- „Ç§„Éô„É≥„Éà„Ç≠„É£„Éó„ÉÅ„É£Áî®„ÅÆÈÄèÊòé„Ç≠„É£„É≥„Éê„Çπ (Â∏∏„Å´ÊúÄ‰∏ä‰Ωç) -->
    <canvas id="event-canvas"></canvas>

    <!-- Â∑¶‰∏ã„ÉÑ„Éº„É´„Éê„Éº: „É¨„Ç§„É§„ÉºÈÅ∏Êäû + „ÉÑ„Éº„É´ÈÅ∏Êäû -->
    <div id="toolbar-left">
        <!-- „É¨„Ç§„É§„Éº„Éë„Éç„É´ (ÂãïÁöÑÁîüÊàê) -->
        <div id="layer-panel">
            <button id="addLayerBtn" class="layer-add-btn">
                +
                <div class="tool-tooltip">„É¨„Ç§„É§„ÉºËøΩÂä†</div>
            </button>
            <div id="layer-buttons">
                <!-- „É¨„Ç§„É§„Éº„Éú„Çø„É≥„ÅØJS„ÅßÂãïÁöÑ„Å´ËøΩÂä† -->
            </div>
        </div>

        <!-- „ÉÑ„Éº„É´„Éë„Éç„É´ („É¨„Ç§„É§„Éº„Åã„ÇâÁã¨Á´ã) -->
        <div id="tool-panel">
            <!-- ÊèèÁîª„ÉÑ„Éº„É´ -->
            <div class="tool-btn" id="drawToolBtn" data-tool="draw">
                <img src="icons/pen.png" class="tool-icon tool-pen active" alt="Pen">
                <img src="icons/bet.png" class="tool-icon tool-fill" style="display:none;" alt="Fill">
                <img src="icons/ata.png" class="tool-icon tool-sketch" style="display:none;" alt="Sketch">
                <img src="icons/tone.png" class="tool-icon tool-tone" style="display:none;" alt="Tone">
                <div class="tool-tooltip">ÊèèÁîª„ÉÑ„Éº„É´</div>
            </div>

            <!-- Ê∂à„Åó„Ç¥„É†„ÉÑ„Éº„É´ -->
            <div class="tool-btn" id="eraserToolBtn" data-tool="eraser">
                <img src="icons/er1.png" class="tool-icon eraser-lasso" style="display:none;" alt="Eraser Lasso">
                <img src="icons/er2.svg" class="tool-icon eraser-pen active" alt="Eraser Pen">
                <div class="tool-tooltip">Ê∂à„Åó„Ç¥„É†„ÉÑ„Éº„É´</div>
            </div>
        </div>

        <!-- „Éñ„É©„Ç∑„Çµ„Ç§„Ç∫„Çπ„É©„Ç§„ÉÄ„Éº -->
        <div id="size-slider-container">
            <div id="sizeDisplay">3</div>
            <input type="range" id="brushSize" min="1" max="20" value="3">
            <div class="tool-tooltip">„Éö„É≥„Çµ„Ç§„Ç∫</div>
        </div>
        <!-- Color Pickers (Relocated) -->
        <div class="tool-btn" id="bgColorBtnWrapper">
            <div style="width: 100%; height: 100%; border-radius: 4px; overflow: hidden;">
                <input type="color" id="bgColorBtn" value="#ffffff" title="ËÉåÊôØËâ≤">
            </div>
            <div class="tool-tooltip tool-tooltip-right">ËÉåÊôØËâ≤</div>
        </div>
    </div>

    <!-- Âè≥‰∏ä„ÉÑ„Éº„É´„Éê„Éº -->
    <div id="toolbar-right">

        <!-- Ë®≠ÂÆö„Éú„Çø„É≥ (AIÁî®) -->
        <div class="tool-btn" id="settingsBtn">
            <svg viewBox="0 0 24 24">
                <path
                    d="M12 15.5A3.5 3.5 0 0 1 8.5 12 3.5 3.5 0 0 1 12 8.5a3.5 3.5 0 0 1 3.5 3.5 3.5 3.5 0 0 1-3.5 3.5m7.43-2.53c.04-.32.07-.64.07-.97s-.03-.66-.07-1l2.11-1.63c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.3-.61-.22l-2.49 1c-.52-.4-1.08-.73-1.69-.98l-.38-2.65A.49.49 0 0 0 14 2h-4c-.25 0-.46.18-.49.42l-.38 2.65c-.61.25-1.17.59-1.69.98l-2.49-1c-.23-.09-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64L4.57 11c-.04.34-.07.67-.07 1s.03.65.07.97l-2.11 1.66c-.19.15-.25.42-.12.64l2 3.46c.12.22.39.3.61.22l2.49-1.01c.52.4 1.08.73 1.69.98l.38 2.65c.03.24.24.42.49.42h4c.25 0 .46-.18.49-.42l.38-2.65c.61-.25 1.17-.58 1.69-.98l2.49 1.01c.22.08.49 0 .61-.22l2-3.46c.12-.22.07-.49-.12-.64l-2.11-1.66z" />
            </svg>
            <div class="tool-tooltip tool-tooltip-bottom">AIË®≠ÂÆö</div>
        </div>

        <div class="tool-btn" id="fileBtn">
            <img src="icons/file.svg" alt="File" style="width: 24px; height: 24px;">
            <div class="tool-tooltip tool-tooltip-bottom">„Éï„Ç°„Ç§„É´ÁÆ°ÁêÜ</div>
        </div>

        <div class="tool-btn" id="saveBtn">
            <svg viewBox="0 0 24 24">
                <path d="M12 4 L12 16 M6 12 L12 18 L18 12" />
                <path d="M4 20 L20 20" />
            </svg>
            <div class="tool-tooltip tool-tooltip-bottom tooltip-offset-2">‰øùÂ≠ò (‚åòS)</div>
        </div>
    </div>

    <!-- „Ç∫„Éº„É†„É™„Çª„ÉÉ„Éà„Éú„Çø„É≥ -->
    <div id="resetZoomBtn">
        <svg viewBox="0 0 24 24">
            <circle cx="12" cy="12" r="8" />
            <path d="M12 7 L12 17 M7 12 L17 12" />
        </svg>
    </div>

    <!-- „Éï„Ç°„Ç§„É´ÁÆ°ÁêÜ„É°„Éã„É•„Éº -->
    <div id="file-menu" class="tool-menu hidden">
        <div class="menu-item" id="newProjectBtn">
            <span>NEW</span>
        </div>
        <div class="menu-item" id="exportProjectBtn">
            <span>SAVE (.json)</span>
        </div>
        <div class="menu-item" id="importProjectBtn">
            <span>LOAD</span>
            <!-- Hidden file input -->
            <input type="file" id="fileInput" accept=".json,.desu" style="display:none;">
        </div>
    </div>

    <!-- ‰øùÂ≠òUI -->
    <div id="save-overlay"></div>
    <div id="save-ui">
        <h3>ÁØÑÂõ≤„Çí„Éâ„É©„ÉÉ„Ç∞„Åó„Å¶ÈÅ∏Êäû</h3>
        <div id="selection-size" style="display:none; font-size: 13px; color: #666; margin-bottom: 8px;"></div>

        <div class="option-group aspect-ratio-group">
            <div class="option-group-label">Á∏¶Ê®™ÊØî</div>
            <div class="option-buttons">
                <button class="option-btn active" data-aspect="free">Ëá™Áî±</button>
                <button class="option-btn" data-aspect="1:1">1:1</button>
                <button class="option-btn" data-aspect="4:5">4:5</button>
                <button class="option-btn" data-aspect="16:9">16:9</button>
                <button class="option-btn" data-aspect="9:16">9:16</button>
            </div>
        </div>

        <div class="option-group">
            <div class="option-group-label">ÂÄçÁéá</div>
            <div class="option-buttons">
                <button class="option-btn active" data-scale="1">1x</button>
                <button class="option-btn" data-scale="2">2x</button>
                <button class="option-btn" data-scale="3">3x</button>
            </div>
        </div>


        <label>
            <input type="checkbox" id="transparentBg">
            ËÉåÊôØÈÄèÈÅé
        </label>

        <div>
            <button class="save-btn" id="saveAllBtn">ÂÖ®‰Ωì„Çí‰øùÂ≠ò</button>
            <button class="save-btn primary" id="confirmSelectionBtn" style="display:none;">Á¢∫ÂÆö</button>
            <button class="save-btn" id="copyClipboardBtn" style="display:none;">„Ç≥„Éî„Éº</button>
            <button class="save-btn" id="redoSelectionBtn" style="display:none;">„ÇÑ„ÇäÁõ¥„Åó</button>
            <button class="save-btn" id="cancelSaveBtn">Èñâ„Åò„Çã</button>
        </div>
    </div>

    <canvas id="selection-canvas"></canvas>


    <!-- „Éá„Éê„ÉÉ„Ç∞„É≠„Ç∞ (ÂâäÈô§Ê∏à„Åø) -->

    <!-- „ÇØ„É¨„Ç∏„ÉÉ„Éà„Éú„Çø„É≥„Å®„É¢„Éº„ÉÄ„É´ -->
    <div id="credit-btn">?</div>
    <div id="credit-modal">
        <div id="credit-content">
            <h2>DESU‚Ñ¢ draw</h2>
            <a href="https://warpshoot.github.io/desu/" target="_blank" id="credit-logo">
                <img src="../images/logo.gif" alt="DESU‚Ñ¢ draw">
            </a>
            <div id="credit-author">
                by <a href="https://warpshoot.github.io/" target="_blank">wpy</a>
            </div>
            <a href="MANUAL.md" target="_blank" class="credit-manual-link">Manual</a>
        </div>
    </div>

    <!-- Ê±éÁî®Á¢∫Ë™ç„É¢„Éº„ÉÄ„É´ -->
    <div id="confirm-modal" class="hidden">
        <div id="confirm-content">
            <p id="confirm-message">„É°„ÉÉ„Çª„Éº„Ç∏</p>
            <label class="confirm-checkbox-label">
                <input type="checkbox" id="confirm-suppress-check">
                Ê¨°Âõû‰ª•ÈôçË°®Á§∫„Åó„Å™„ÅÑ
            </label>
            <div class="confirm-buttons">
                <button id="confirm-cancel-btn">„Ç≠„É£„É≥„Çª„É´</button>
                <button id="confirm-ok-btn" class="primary">OK</button>
            </div>
        </div>
    </div>

    <!-- ÊèèÁîª„ÉÑ„Éº„É´ÈÅ∏Êäû„É°„Éã„É•„Éº (Èï∑Êäº„Åó„Éù„ÉÉ„Éó„Ç™„Éº„Éê„Éº) -->
    <div id="draw-tool-menu" class="tool-menu hidden">
        <div class="menu-item" data-mode="pen">
            <img src="icons/pen.png" alt="Pen">
        </div>
        <div class="menu-item" data-mode="fill">
            <img src="icons/bet.png" alt="Fill">
        </div>
        <div class="menu-item" data-mode="tone">
            <img src="icons/tone.png" alt="Tone">
        </div>
        <div class="menu-item" data-mode="sketch">
            <img src="icons/ata.png" alt="Sketch">
        </div>
    </div>

    <!-- Ê∂à„Åó„Ç¥„É†„ÉÑ„Éº„É´ÈÅ∏Êäû„É°„Éã„É•„Éº (Èï∑Êäº„Åó„Éù„ÉÉ„Éó„Ç™„Éº„Éê„Éº) -->
    <div id="eraser-tool-menu" class="tool-menu hidden">
        <div class="menu-item" data-mode="eraser_lasso">
            <img src="icons/er1.png" alt="Eraser Lasso">
        </div>
        <div class="menu-item" data-mode="eraser_pen">
            <img src="icons/er2.svg" alt="Eraser Pen">
        </div>
        <div class="menu-item eraser-clear" data-mode="layer_clear">
            <svg viewBox="0 0 24 24" class="layer-clear-icon">
                <path
                    d="M12 4 L12 2 M12 22 L12 20 M4 12 L2 12 M22 12 L20 12 M6.34 6.34 L4.93 4.93 M19.07 19.07 L17.66 17.66 M6.34 17.66 L4.93 19.07 M19.07 4.93 L17.66 6.34" />
            </svg>
        </div>
    </div>

    <!-- „Éà„Éº„É≥ÈÅ∏Êäû„É°„Éã„É•„Éº („ÉÑ„Éº„É´„Éê„Éº„ÅÆ‰∏ä„Å´Ë°®Á§∫) -->
    <div id="tone-menu" class="tone-menu hidden">
        <div class="tone-menu-header">
            <div id="tone-menu-pin" class="tone-menu-pin" title="„É°„Éã„É•„Éº„ÇíÂõ∫ÂÆö"></div>
        </div>
        <div id="tone-items" class="tone-items">
            <!-- JS„ÅßÂãïÁöÑ„Å´ÁîüÊàê -->
        </div>
    </div>

    <!-- „É¨„Ç§„É§„ÉºÊìç‰Ωú„É°„Éã„É•„Éº (Èï∑Êäº„Åó„Éù„ÉÉ„Éó„Ç™„Éº„Éê„Éº) -->
    <div id="layer-menu" class="tool-menu layer-menu-horizontal hidden">
        <input type="range" id="layerOpacitySlider" min="0" max="100" value="100" title="‰∏çÈÄèÊòéÂ∫¶">
        <div class="menu-item layer-visible-toggle" title="Ë°®Á§∫/ÈùûË°®Á§∫">
            <svg viewBox="0 0 24 24" class="eye-icon">
                <path d="M2 12 C2 12 5 5 12 5 C19 5 22 12 22 12 C22 12 19 19 12 19 C5 19 2 12 2 12 Z" />
                <circle cx="12" cy="12" r="3" />
            </svg>
        </div>
        <div class="menu-item layer-move-btn" data-dir="up" title="‰∏ä„Å∏">
            <svg viewBox="0 0 24 24">
                <path d="M12 8 L6 14 L18 14 Z" fill="currentColor" />
            </svg>
        </div>
        <div class="menu-item layer-move-btn" data-dir="down" title="‰∏ã„Å∏">
            <svg viewBox="0 0 24 24">
                <path d="M12 16 L6 10 L18 10 Z" fill="currentColor" />
            </svg>
        </div>
        <div class="menu-item layer-merge-btn" title="‰∏ã„ÅÆ„É¨„Ç§„É§„Éº„Å´Áµ±Âêà">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                stroke-linejoin="round">
                <path d="M7 21h10" />
                <path d="M12 3v14" />
                <path d="M8 13l4 4 4-4" />
            </svg>
        </div>
        <div class="menu-item layer-delete danger" title="ÂâäÈô§">
            <svg viewBox="0 0 24 24">
                <path d="M6 6 L18 18 M6 18 L18 6" />
            </svg>
        </div>
    </div>

    <div id="ai-chat-panel">
        <div id="ai-chat-header" style="cursor: grab;">
            <span id="ai-chat-title">Fano</span>
            <div id="ai-chat-header-btns">
                <span id="ai-chat-status"></span>
                <button id="ai-pause-btn" title="Áõ£Ë¶ñ„É¢„Éº„ÉâÂàáÊõø">‚óè LIVE</button>
            </div>
        </div>
        <div id="ai-chat-messages">
            <!-- AI„Ç≥„É°„É≥„Éà„Åå„Åì„Åì„Å´Âêπ„ÅçÂá∫„ÅóÈ¢®„ÅßËøΩÂä†„Åï„Çå„Çã -->
        </div>
        <div id="ai-chat-footer">
            <button id="ai-chat-mic" title="Èü≥Â£∞ÂÖ•Âäõ">
                <svg viewBox="0 0 24 24" width="16" height="16">
                    <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"
                        fill="currentColor" />
                    <path
                        d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"
                        fill="currentColor" />
                </svg>
            </button>
            <input type="text" id="ai-chat-input" placeholder="„É°„ÉÉ„Çª„Éº„Ç∏..." autocomplete="off">
            <button id="ai-chat-send">
                <svg viewBox="0 0 24 24" width="16" height="16">
                    <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z" fill="currentColor" />
                </svg>
            </button>
        </div>
        <div id="ai-chat-resizer"></div>
    </div>

    <!-- ============================================ -->
    <!-- Ë®≠ÂÆö„É¢„Éº„ÉÄ„É´ -->
    <!-- ============================================ -->
    <div id="settings-modal" class="hidden">
        <div id="settings-content">
            <h3>Options</h3>

            <div class="settings-group settings-toggle-group"
                style="padding-bottom: 12px; border-bottom: 1px solid #eee; margin-bottom: 20px;">
                <label for="settings-ai-enabled" style="font-weight: bold; color: #333;">AIÁõ£Ë¶ñ„É¢„Éº„Éâ (Ë©¶È®ì‰∏≠)</label>
                <input type="checkbox" id="settings-ai-enabled">
            </div>

            <div id="ai-settings-fields">

                <div class="settings-group">
                    <label for="settings-provider">API Provider</label>
                    <select id="settings-provider">
                        <option value="anthropic">Anthropic</option>
                        <option value="google" selected>Google</option>
                        <option value="openai">OpenAI</option>
                    </select>
                </div>

                <div class="settings-group">
                    <label for="settings-model">Model</label>
                    <select id="settings-model">
                        <!-- Populated by JS -->
                    </select>
                </div>

                <div class="settings-group">
                    <label for="settings-apikey">API Key</label>
                    <input type="password" id="settings-apikey" placeholder="sk-... / AIza...">
                </div>

                <div class="settings-group">
                    <label for="settings-debounce">ÈÄÅ‰ø°ÈñìÈöî (Áßí)</label>
                    <input type="number" id="settings-debounce" min="1" max="30" value="3">
                </div>

                <div class="settings-group settings-toggle-group">
                    <label for="settings-tts">Ë™≠„Åø‰∏ä„Åí</label>
                    <input type="checkbox" id="settings-tts">
                </div>

                <div class="settings-group">
                    <label for="settings-history-limit">Ë®òÊÜ∂‰øùÊåÅÊï∞ („É°„ÉÉ„Çª„Éº„Ç∏Êï∞)</label>
                    <div style="display: flex; gap: 8px;">
                        <input type="number" id="settings-history-limit" min="0" max="100" value="10"
                            style="width: 60px;">
                        <button id="settings-clear-history" class="settings-reset-btn"
                            style="flex: 1;">„Åì„Çå„Åæ„Åß„ÅÆ‰ºöË©±„ÇíÂøò„Çå„Çã</button>
                    </div>
                </div>

                <div class="settings-group">
                    <label for="settings-display-name">Ë°®Á§∫Âêç</label>
                    <input type="text" id="settings-display-name" placeholder="üëÄ" value="üëÄ">
                </div>

                <div class="settings-group">
                    <div class="settings-prompt-header">
                        <label for="settings-prompt">„Ç≠„É£„É©Ë®≠ÂÆö</label>
                        <button id="settings-prompt-reset" class="settings-reset-btn">„É™„Çª„ÉÉ„Éà</button>
                    </div>
                    <textarea id="settings-prompt" rows="8" spellcheck="false"></textarea>
                </div>
            </div>

            <button id="settings-close-btn">Èñâ„Åò„Çã</button>
        </div>
    </div>

    <!-- Debug Display (set DEBUG_MODE = true in ui.js to enable) -->
    <div id="debug-display"
        style="display: none; position: fixed; top: 10px; left: 10px; background: rgba(0,0,0,0.8); color: #0f0; padding: 10px; font-family: monospace; font-size: 12px; z-index: 10000; pointer-events: none; border-radius: 5px;">
    </div>

    <!-- Scripts -->
    <script type="module" src="js/main.js"></script>
    <script>if ('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js');</script>
</body>

</html>