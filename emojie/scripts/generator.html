<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Emoji Data Generator</title>
</head>

<body>
    <h1>Generating Data...</h1>
    <div id="status">Processing...</div>
    <button id="downloadBtn" style="display:none; font-size: 20px; padding: 20px;">Download emojis.js</button>

    <script src="source.js"></script>
    <script>
        const categoryMap = {
            "Smileys & Emotion": "smileys",
            "People & Body": "people",
            "Animals & Nature": "animals",
            "Food & Drink": "food",
            "Travel & Places": "travel",
            "Activities": "activities",
            "Objects": "objects",
            "Symbols": "symbols",
            "Flags": "flags"
        };

        async function generate() {
            const data = window.rawData;
            if (!data) {
                document.getElementById('status').textContent = 'Error: No data found in window.rawData';
                return;
            }

            const categorizedEmojis = {};
            // Initialize arrays
            Object.values(categoryMap).forEach(k => categorizedEmojis[k] = []);

            const keywordsDict = {};

            // Sort by sort_order
            data.sort((a, b) => (a.sort_order || 0) - (b.sort_order || 0));

            data.forEach(item => {
                const unified = item.unified;
                const codes = unified.split('-').map(h => parseInt(h, 16));
                const emoji = String.fromCodePoint(...codes);

                const cat = item.category;
                if (!cat) return;

                let key = categoryMap[cat];
                if (!key) {
                    key = cat.toLowerCase().replace(/&/g, '').replace(/  /g, ' ').replace(/ /g, '_');
                    if (!categorizedEmojis[key]) categorizedEmojis[key] = [];
                }

                // Add emoji
                categorizedEmojis[key].push(emoji);

                // Keywords
                const kwList = [item.short_name || '']
                    .concat(item.short_names || [])
                    .concat(item.keywords || []);

                const uniqueKws = [...new Set(kwList.filter(k => k))];
                keywordsDict[emoji] = uniqueKws.join(' ');
            });

            // Build JS
            let js = "// DESUâ„¢ emojie - Generated Emoji Data\n";
            js += "// Generated by generator.html\n\n";
            js += "window.emojiData = {\n";

            let first = true;
            for (const [key, list] of Object.entries(categorizedEmojis)) {
                if (list.length === 0) continue;
                if (!first) js += ",\n";
                first = false;

                js += `    ${key}: [\n`;

                let buffer = "        ";
                list.forEach((emo, i) => {
                    buffer += `'${emo}'`;
                    if (i < list.length - 1) buffer += ", ";

                    if (buffer.length > 100) {
                        js += buffer + "\n";
                        buffer = "        ";
                    }
                });
                if (buffer.trim()) js += buffer + "\n";
                js += "    ]";
            }
            js += "\n};\n\n";

            js += "window.emojiKeywords = " + JSON.stringify(keywordsDict, null, 4) + ";\n";

            // Create Blob
            const blob = new Blob([js], { type: 'application/javascript' });
            const url = URL.createObjectURL(blob);

            const btn = document.getElementById('downloadBtn');
            btn.style.display = 'block';
            btn.textContent = `Download emojis.js (${(blob.size / 1024).toFixed(1)} KB)`;
            btn.onclick = () => {
                const a = document.createElement('a');
                a.href = url;
                a.download = 'emojis.js';
                a.click();
            };

            document.getElementById('status').textContent = 'Ready!';

            // Auto click
            btn.click();
        }

        window.onload = generate;
    </script>
</body>

</html>