# DESU™ beep AI Composition Manual

このドキュメントは、AIアシスタントが **DESU™ beep** 用の楽曲データ（JSON）を生成するための仕様書です。
ユーザーから楽曲作成の依頼があった場合、この仕様に従ってJSONデータを生成し、提供してください。

[人間向けマニュアル (For Humans)](./beep_MANUAL.md)

## エンジン
Tone.jsベース。**8bitゲーム機（NES/GB）** を模した波形合成エンジン（Pulse / Noise）。
サンプルは使用せず、すべてリアルタイム合成です。

## トラック構成（5トラック × 16ステップ）

| # | 名前 | シンセタイプ | ベース音程 | 特徴 |
|---|------|------------|-----------|------|
| 0 | Kick | **pulse-kick** | C2 | 矩形波ベースの硬いキック |
| 1 | Snare | **chip-noise** | C4 | 短いホワイトノイズ（NESスネア） |
| 2 | Hi-hat | **chip-noise** | C6 | 極短の高音ノイズ |
| 3 | Bass | **pulse** (Square) | C2 | 矩形波/パルス波ベース |
| 4 | Lead | **pulse** (Square) | C4 | 矩形波/パルス波リード |

## トラックパラメータ（全パターン共通）

各トラックに以下の6つのノブがあります。
**チップチューンらしさを出すには `decay` を短く設定するのがコツです。**

| パラメータ | 範囲 | デフォルト | スケール | 説明 |
|-----------|------|-----------|---------|------|
| tune | -24〜+24 | 0 | linear | 半音単位のピッチシフト |
| cutoff | 100〜16000 | varies | log | ローパスフィルター (Hz) |
| resonance | 0.5〜15 | 1 | log | フィルターのQ値（ピコピコ感に重要） |
| drive | 0〜100 | 0 | linear | ソフトクリップ歪み(%)。上げると太くなる |
| decay | 0.01〜2.0 | varies | log | **音の減衰時間(秒)。基本は0.05〜0.3と短め** |
| vol | 0〜2.0 | 0.7 | linear | 音量倍率 |

`trackParams` はトップレベルに1つだけ存在し、全パターン共通です（パターン個別には持ちません）。

## セルパラメータ（1ステップごとの設定）

16ステップ各セルに以下の設定がある：

| パラメータ | 範囲 | デフォルト | 説明 |
|-----------|------|-----------|------|
| active | true/false | false | そのステップで音を鳴らすか |
| velocity | 0.0〜1.0 | 1.0 | **音の強弱**。3段階タップにより `1.0` (Strong) か `0.5` (Weak) が設定されます |
| pitch | -36〜+36 | 0 | 半音単位のピッチオフセット（再生時にスケールで量子化） |
| duration | 0.1〜4.0 | 1.0 | 音の長さ（1.0 = 1ステップ分）。**短く切るとスタッカートでチップ感が出る** |
| rollMode | true/false | false | 連打モード |
| rollSubdivision | 1, 2, 4, 8 | 4 | 連打の分割数（高速アルペジオ効果に有用） |

最終的なピッチ = ベース音程 + tune + (trackOctave × 12) + pitch (※再生時にスケールで量子化)

### Velocity（強弱）の挙動
`velocity` が `1.0` 未満（Weak）の場合、以下の実際の音量係数が適用されます：
- **Noise / Chip-noise (Track 1, 2)**: 実質 `0.7`
- **Pulse / Pulse-kick (Track 0, 3, 4)**: 実質 `0.5`

## ステップの表記（コンパクト形式）

ファイルサイズ削減のため、デフォルト値は省略する。

| 表記 | 意味 |
|------|------|
| `0` | 非アクティブ、全パラメータがデフォルト |
| `1` | アクティブ、全パラメータがデフォルト（pitch=0, duration=1.0, velocity=1.0, rollMode=false, rollSubdivision=4） |
| `{"active":true, ...}` | アクティブで一部パラメータがデフォルトと異なる。デフォルト値のプロパティは省略可 |

## スケール

pitchの量子化に使われる。以下から選択：

- `Chromatic` (デフォルト): [0,1,2,3,4,5,6,7,8,9,10,11]
- `Major`: [0,2,4,5,7,9,11]
- `Minor`: [0,2,3,5,7,8,10]
- `Dorian`: [0,2,3,5,7,9,10]
- `Phrygian`: [0,1,3,5,7,8,10]
- `Penta Maj`: [0,2,4,7,9]
- `Penta Min`: [0,3,5,7,10]
- `Blues`: [0,3,5,6,7,10]
- `Harm Min`: [0,2,3,5,7,8,11]
- `Ryukyu`: [0,4,5,7,11]

## グローバル設定とパターンチェイン

JSONのトップレベルに以下の設定を記述します。

*   `bpm`: テンポ (60-180)。デフォルト: 120。
*   `masterVolume`: マスター音量（dB単位）。デフォルト: -12。
*   `swingLevel`: `"OFF"`, `"LIGHT"`, `"HEAVY"`。スウィング（ハネ）の強さ（全パターン共通設定）。
    *   `OFF`: 0% (Even)
    *   `LIGHT`: 約58%
    *   `HEAVY`: 約67%
*   `chainMode`: `"chain"` (順次再生) または `"live"` (予約再生)。通常は `"chain"` を推奨。
*   `chain`: パターン再生順序の配列 (最大8つ・0-7のインデックス)。
    *   `[0, 1, 0, 2, null, null, null, null]` のように指定。
    *   指定がないスロットは `null`。
    *   `chainMode="chain"` の場合、この配列の順にパターンが自動で切り替わります（0→1→0→2→最初に戻る）。展開を作るのに必須の機能です。

## パターン内設定 (Pattern Properties)
各パターンオブジェクトには以下のプロパティを含めることができます。

*   `scale`: 使用するスケール名（文字列）。デフォルト: `"Chromatic"`。
*   `trackOctaves`: トラックごとのオクターブオフセット（5要素の整数配列）。
    *   範囲: `-2` 〜 `2`。デフォルト: `[0,0,0,0,0]`。
    *   例: `[0, 0, 0, -1, 1]` (Track 3を1オクターブ下げ、Track 4を1オクターブ上げる)。
    *   UIには存在しない隠しプロパティで、AIが曲の音域を制御するのに非常に有効です。

### パターンレベルの省略ルール

以下のフィールドはデフォルト値のとき省略可：
- `scale`（デフォルト: `"Chromatic"`）
- `trackOctaves`（デフォルト: `[0,0,0,0,0]`）
- `mutedTracks`（デフォルト: `[false,false,false,false,false]`）
- `soloedTracks`（デフォルト: `[false,false,false,false,false]`）
- `automation`（デフォルト: なし）

### トップレベルの省略ルール

以下のフィールドはデフォルト値のとき省略可：
- `masterVolume`（デフォルト: `-12`）
- `swingLevel`（デフォルト: `"OFF"`）
- `nextPattern`（デフォルト: `null`）
- `repeatEnabled`（デフォルト: `true`）
- `chainMode`（デフォルト: `"chain"`）
- `chain`（デフォルト: 全null）

## オートメーション (automation)
DJモードのエフェクトはステップ単位で制御可能です。パターンの `automation` フィールドに記述します。
チップチューンでは、意図的なバグ表現（グリッチ）として有効です。

*   `x`: フィルターX軸（横方向）の配列（-0.5〜0.5 / null はデータなし）
*   `y`: フィルターY軸（縦方向）の配列（-0.5〜0.5 / null はデータなし）
*   `pitch`: リボンコントローラのピッチ変移配列（-2.0〜+2.0オクターブ / null はデータなし）
*   `fx`: 各FXチャンネルのON/OFF状態（true/null）を持つオブジェクト
    *   `stutter`: 配列 (16ステップ) ※UI上の **`GATE`** ボタン（矩形波トレモロ）に対応
    *   `slow`: テープストップ効果 (`SLOW`ボタン)
    *   `crush`: 激しいビットクラッシュ (`CRSH`ボタン)
    *   `loop`: 配列 (16ステップ) ※UI上の **`STUT`** ボタン。**現在AUTO記録・再生対象外のため、JSONで指定しても無視されます。**

※特に `pitch` を使うとダイナミックなピッチベンドが可能です。

## JSON構造・省略ルール

*   デフォルト値は省略可能（ファイルサイズ削減のため推奨）。
*   **省略不可**: `grid` は必ず 5トラック × 16ステップ の配列構造を持つこと。
*   全8パターン分出力すること（未使用パターンは `grid` のみでよい）。
*   JSONを出力する際は、必ずMarkdownのコードブロック（```json ... ```）で囲んでください。
*   **重要**: JSONデータは省略せずに完全に出力してください。「...」や「以下同様」のような省略表記は禁止です。

### 例: シンプルな8ビート＋展開あり＋FX

```json
{
  "bpm": 140,
  "chainMode": "chain",
  "chain": [0, 1, 0, 2, null, null, null, null],
  "trackParams": [
    {"tune": 0, "cutoff": 4000, "resonance": 1, "drive": 20, "decay": 0.1, "vol": 0.9},
    {"tune": 0, "cutoff": 6000, "resonance": 2, "drive": 10, "decay": 0.08, "vol": 0.75},
    {"tune": 12, "cutoff": 14000, "resonance": 1, "drive": 0, "decay": 0.03, "vol": 0.5},
    {"tune": 0, "cutoff": 3000, "resonance": 1, "drive": 10, "decay": 0.2, "vol": 1.0},
    {"tune": 0, "cutoff": 8000, "resonance": 1, "drive": 5, "decay": 0.15, "vol": 0.7}
  ],
  "patterns": [
    {
      "scale": "Minor",
      "grid": [
        [1,0,0,0, 1,0,0,0, 1,0,0,0, 1,0,0,0],
        [0,0,0,0, 1,0,0,0, 0,0,0,0, 1,0,0,0],
        [1,{"active":true,"velocity":0.5},1,{"active":true,"velocity":0.5}, 1,{"active":true,"velocity":0.5},1,{"active":true,"velocity":0.5}, 1,{"active":true,"velocity":0.5},1,{"active":true,"velocity":0.5}, 1,{"active":true,"velocity":0.5},1,{"active":true,"velocity":0.5}],
        [{"active":true,"pitch":0},0,0,0, {"active":true,"pitch":0},0,0,0, {"active":true,"pitch":3},0,0,0, {"active":true,"pitch":5},0,0,0],
        [0,0,0,0, 0,0,0,0, 0,0,0,0, 0,0,0,0]
      ]
    },
    {
      "automation": {
        "fx": {
          "crush": [null,null,null,null, null,null,null,null, null,null,null,null, true,true,true,true]
        }
      },
      "grid": [
        [1,0,1,0, 1,0,1,0, 1,0,1,0, 1,1,1,1],
        [0,0,0,0, 1,0,0,0, 0,0,1,0, 1,1,1,0],
        [1,1,1,0, 1,1,1,0, 1,1,1,0, 0,0,0,0],
        [{"active":true,"pitch":0},0,0,0, {"active":true,"pitch":12},{"active":true,"pitch":12},0,0, 0,0,0,0, 0,0,0,0],
        [0,0,0,0, 0,0,0,0, 0,0,0,0, {"active":true,"pitch":12,"rollMode":true,"rollSubdivision":8},0,0,0]
      ]
    },
    {"grid":[[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]]},
    {"grid":[[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]]},
    {"grid":[[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]]},
    {"grid":[[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]]},
    {"grid":[[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]]},
    {"grid":[[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]]}
  ]
}
```

## 音作り推奨プリセット（Chiptune）

もし音色（trackParams）も指定する場合の参考値。

### Kick (Pulse Kick)
| 名前 | tune | cutoff | resonance | drive | decay | vol |
|------|------|--------|-----------|-------|-------|-----|
| Tight | 0 | 4000 | 1 | 20 | **0.1** | 0.9 |
| Deep | -12 | 1000 | 1 | 40 | 0.25 | 1.0 |
| Zap/Laser | 12 | 8000 | 4 | 60 | 0.05 | 0.8 |
| Boomy | 5 | 6000 | 2 | 10 | 0.4 | 0.9 |

### Snare (Chip Noise)
| 名前 | tune | cutoff | resonance | drive | decay | vol |
|------|------|--------|-----------|-------|-------|-----|
| Snappy | 0 | 6000 | 2 | 10 | **0.08** | 0.75 |
| Crunch | -6 | 3000 | 5 | 30 | 0.2 | 0.8 |
| Glitch Click | 12 | 12000 | 8 | 50 | 0.04 | 0.7 |
| Soft | 0 | 5000 | 1 | 0 | 0.3 | 0.6 |

### Hi-hat (Chip Noise)
| 名前 | tune | cutoff | resonance | drive | decay | vol |
|------|------|--------|-----------|-------|-------|-----|
| Crisp | 12 | 14000 | 1 | 0 | **0.03** | 0.5 |
| Metal/Ring | 0 | 8000 | 4 | 20 | 0.1 | 0.6 |
| High Zap | 24 | 16000 | 8 | 40 | 0.02 | 0.4 |
| Industrial | -12 | 2000 | 1 | 60 | 0.2 | 0.7 |

### Bass (Pulse/Square)
| 名前 | tune | cutoff | resonance | drive | decay | vol |
|------|------|--------|-----------|-------|-------|-----|
| Clear | 0 | 3000 | 1 | 10 | **0.2** | 1.0 |
| Sub | -12 | 1000 | 1 | 30 | 0.5 | 1.2 |
| Acid | 0 | 6000 | 8 | 60 | 0.15 | 0.9 |
| Pluck | 7 | 4000 | 2 | 0 | 0.05 | 1.0 |

### Lead (Pulse/Square)
| 名前 | tune | cutoff | resonance | drive | decay | vol |
|------|------|--------|-----------|-------|-------|-----|
| Defined | 0 | 8000 | 1 | 5 | **0.15** | 0.7 |
| Arp/Pluck | 12 | 12000 | 2 | 20 | **0.05** | 0.6 |
| Pad-ish | -12 | 2000 | 1 | 40 | 0.6 | 0.8 |
| Distorted | 7 | 6000 | 6 | 80 | 0.2 | 0.7 |

## 重要な制約

- `grid` は必ず **5トラック × 16ステップ**（省略不可）
- pitchはスケール設定に関係なく半音単位で指定（再生時にスケールで量子化される）
- Kick/Snare/Hi-hatはモノフォニック（pitchは音色変化に使える）
- 非アクティブでデフォルト値のセルは `0`、アクティブでデフォルト値のセルは `1` と表記する
- `trackParams` はトップレベルに1つのみ（パターン個別には持たない）
- 全8パターン分出力すること（未使用パターンは `grid` のみでよい）
- `loop` FXはJSONで指定しても現在は無視される

## AI作成時のヒント

- 楽曲ジャンル（Chiptune, 8bit BGM, Retro Game, Hyperpopなど）に応じて、適切なBPMと音色パラメータを選択してください。
- `decay` を短く（0.03〜0.2）するとチップチューンらしいパキパキした音になります。
- パターン展開（Intro, Main, Break, Fill）を意識し、単調にならないようにchainを活用してください。
- `rollMode` と `rollSubdivision` を使うと16分・32分音符のアルペジオ効果が出せます。
- `velocity: 0.5` (Weak) でハイハットのアクセントを付けると、グルーヴ感が出ます。
