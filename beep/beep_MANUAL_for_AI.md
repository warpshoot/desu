# DESU™ beep AI Composition Manual

このドキュメントは、AIアシスタントが **DESU™ beep** 用の楽曲データ（JSON）を生成するための仕様書です。
ユーザーから楽曲作成の依頼があった場合、この仕様に従ってJSONデータを生成し、提供してください。

[人間向けマニュアル (For Humans)](./beep_MANUAL.md)

## エンジン
Tone.jsベース。**8bitゲーム機（NES/GB）** を模した波形合成エンジン（Pulse / Noise）。
サンプルは使用せず、すべてリアルタイム合成です。

## トラック構成（5トラック × 16ステップ）

| # | 名前 | シンセタイプ | ベース音程 | 特徴 |
|---|------|------------|-----------|------|
| 0 | Kick | **pulse-kick** | C2 | 矩形波ベースの硬いキック |
| 1 | Snare | **chip-noise** | C4 | 短いホワイトノイズ（NESスネア） |
| 2 | Hi-hat | **chip-noise** | C6 | 極短の高音ノイズ |
| 3 | Bass | **pulse** (Square) | C2 | 矩形波/パルス波ベース |
| 4 | Lead | **pulse** (Square) | C4 | 矩形波/パルス波リード |

## トラックパラメータ（全パターン共通）

各トラックに以下の6つのノブがあります。
**チップチューンらしさを出すには `decay` を短く設定するのがコツです。**

| パラメータ | 範囲 | デフォルト | スケール | 説明 |
|-----------|------|-----------|---------|------|
| tune | -24〜+24 | 0 | linear | 半音単位のピッチシフト |
| cutoff | 100〜16000 | varies | log | ローパスフィルター (Hz) |
| resonance | 0.5〜15 | 1 | log | フィルターのQ値（ピコピコ感に重要） |
| drive | 0〜100 | 0 | linear | ソフトクリップ歪み(%)。上げると太くなる |
| decay | 0.01〜2.0 | varies | log | **音の減衰時間(秒)。基本は0.05〜0.3と短め** |
| vol | 0〜2.0 | 0.7 | linear | 音量倍率 |

## セルパラメータ（1ステップごとの設定）

16ステップ各セルに以下の設定がある：

| パラメータ | 範囲 | デフォルト | 説明 |
|-----------|------|-----------|------|
| active | true/false | false | そのステップで音を鳴らすか |
| velocity | 0.0〜1.0 | 1.0 | **音の強弱**。3段階タップにより `1.0` (Strong) か `0.5` (Weak) が設定されます。 |
| pitch | -36〜+36 | 0 | 半音単位のピッチオフセット |
| duration | 0.1〜1.0 | 0.5 | 音の長さ。**短く切るとスタッカートでチップ感が出る** |
| rollMode | true/false | false | 連打モード |
| rollSubdivision | 1, 2, 4, 8 | 4 | 連打の分割数（高速アルペジオ効果に有用） |

### Velocity（強弱）の挙動
`velocity` が `1.0` 未満（Weak）の場合、以下の実際の音量係数が適用されます：
- **Noise / Chip-noise (Track 1, 2)**: 実質 `0.7`
- **FM / Pulse / Membrane (Track 0, 3, 4)**: 実質 `0.5`
- その他: `0.65`

## グローバル設定とパターンチェイン

JSONのトップレベルに以下の設定を記述します。

*   `bpm`: テンポ (60-180)。
*   `swingLevel`: `"OFF"`, `"LIGHT"`, `"HEAVY"`。スウィング（ハネ）の強さ（全局共通設定）。
    *   `OFF`: 0% (Even)
    *   `LIGHT`: 約58%
    *   `HEAVY`: 約67%
*   `chainMode`: `"chain"` (順次再生) または `"live"` (予約再生)。通常は `"chain"` を推奨。
*   `chain`: パターン再生順序の配列 (最大8つ・0-7のインデックス)。
    *   `[0, 1, 0, 2, null, null, null, null]` のように指定。
    *   指定がないスロットは `null`。
    *   `chainMode="chain"` の場合、この配列の順にパターンが自動で切り替わります（0→1→0→2→最初に戻る）。展開を作るのに必須の機能です。

## パターン内設定 (Pattern Properties)
各パターンオブジェクトには以下のプロパティを含めることができます。

*   `scale`: 使用するスケール名（文字列）。
    *   `Chromatic` (デフォルト), `Major`, `Minor`, `Dorian`, `Phrygian`, `Penta Maj`, `Penta Min`, `Blues`, `Harm Min`, `Ryukyu`.
*   `trackOctaves`: トラックごとのオクターブオフセット（5要素の整数配列）。
    *   範囲: `-2` 〜 `2`。
    *   例: `[0, 0, 0, -1, 1]` (Track 3を1オクターブ下げ、Track 4を1オクターブ上げる)。
    *   UIには存在しない隠しプロパティで、AIが曲の音域を制御するのに非常に有効です。

## オートメーション (FX)
DJモードのエフェクトはステップ単位で制御可能です。パターンの `automation` フィールドに記述します。
チップチューンでは、意図的なバグ表現（グリッチ）として有効です。

*   `automation`: オブジェクト
    *   `fx`: 各エフェクトの配列を含むオブジェクト
        *   `stutter`: `[null, true, true, null, ...]` のように、効かせたいステップに `true` を、それ以外に `null` を指定 (16ステップ)。
            *   **注意**: これはUI上の **`GATE`** ボタン（矩形波トレモロ）に対応します。
        *   `slow`: テープストップ効果 (`SLOW`ボタン)。ブレイクで `true` にすると効果的。
        *   `crush`: 激しいビットクラッシュ (`CRSH`ボタン)。フィルインやインパクトに使用。
        *   **注意**: UI上の **`STUT`** (Loop) ボタンは、現在の拍をキャプチャする機能のため、**オートメーションできません**。JSONで指定しても無視されます。

## JSON構造・省略ルール

*   デフォルト値は省略可能（ファイルサイズ削減のため推奨）。
*   gridのみ必須。
*   **省略不可**: `grid` は必ず 5トラック × 16ステップ の配列構造を持つこと。

### 例: シンプルな8ビート＋展開あり＋FX

```json
{
  "bpm": 140,
  "chainMode": "chain",
  "chain": [0, 1, 0, 2, null, null, null, null], // パターン0→1→0→2と再生
  "patterns": [
    {
      "scale": "Chromatic",
      "grid": [
        [1,0,0,0, 1,0,0,0, 1,0,0,0, 1,0,0,0], // Kick
        [0,0,0,0, 1,0,0,0, 0,0,0,0, 1,0,0,0], // Snare
        [1,{"active":true,"velocity":0.5},1,{"active":true,"velocity":0.5}, 1,{"active":true,"velocity":0.5},1,{"active":true,"velocity":0.5}, 1,{"active":true,"velocity":0.5},1,{"active":true,"velocity":0.5}, 1,{"active":true,"velocity":0.5},1,{"active":true,"velocity":0.5}], // Hat (Velocityを使った強弱)
        [{"active":true,"pitch":0},0,0,0, {"active":true,"pitch":0},0,0,0, {"active":true,"pitch":3},0,0,0, {"active":true,"pitch":5},0,0,0], // Bass
        [0,0,0,0, 0,0,0,0, 0,0,0,0, 0,0,0,0]  // Lead
      ]
    },
    {
      // パターン1: フィルイン＋Crush FX
      "automation": {
        "fx": {
            // 最後の4ステップだけCrushをかける
            "crush": [null,null,null,null, null,null,null,null, null,null,null,null, true,true,true,true]
        }
      },
      "grid": [
        [1,0,1,0, 1,0,1,0, 1,0,1,0, 1,1,1,1], // Kick連打
        [0,0,0,0, 1,0,0,0, 0,0,1,0, 1,1,1,0], // Snare
        [1,1,1,0, 1,1,1,0, 1,1,1,0, 0,0,0,0], // Hat
        [{"active":true,"pitch":0},0,0,0, {"active":true,"pitch":12},{"active":true,"pitch":12},0,0, 0,0,0,0, 0,0,0,0], // Bass Slide
        [0,0,0,0, 0,0,0,0, 0,0,0,0, {"active":true,"pitch":12,"rollMode":true,"rollSubdivision":8},0,0,0] // Lead Roll
      ]
    },
    // ... 他のパターン (空でも記述すること)
    {"grid":[[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]]},
    {"grid":[[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]]},
    {"grid":[[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]]},
    {"grid":[[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]]},
    {"grid":[[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]]},
    {"grid":[[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]]}
  ]
}
```

## 音作り推奨プリセット（Chiptune）

もし音色（trackParams）も指定する場合の参考値。

### Kick (Pulse Kick)
| 名前 | tune | cutoff | resonance | drive | decay | vol |
|------|------|--------|-----------|-------|-------|-----|
| Tight | 0 | 4000 | 1 | 20 | **0.1** | 0.9 |
| Deep | -12 | 1000 | 1 | 40 | 0.25 | 1.0 |

### Snare (Chip Noise)
| 名前 | tune | cutoff | resonance | drive | decay | vol |
|------|------|--------|-----------|-------|-------|-----|
| Snappy | 0 | 6000 | 2 | 10 | **0.08** | 0.75 |
| Crunch | -6 | 3000 | 5 | 30 | 0.2 | 0.8 |

### Hi-hat (Chip Noise)
| 名前 | tune | cutoff | resonance | drive | decay | vol |
|------|------|--------|-----------|-------|-------|-----|
| Crisp | 12 | 14000 | 1 | 0 | **0.03** | 0.5 |
| Zap | 24 | 16000 | 4 | 20 | 0.02 | 0.4 |

### Bass (Pulse/Square)
| 名前 | tune | cutoff | resonance | drive | decay | vol |
|------|------|--------|-----------|-------|-------|-----|
| Clear | 0 | 3000 | 1 | 10 | **0.2** | 1.0 |
| Sub | -12 | 1000 | 1 | 30 | 0.5 | 1.2 |
| Acid | 0 | 6000 | 8 | 60 | 0.15 | 0.9 |

### Lead (Pulse/Square)
| 名前 | tune | cutoff | resonance | drive | decay | vol |
|------|------|--------|-----------|-------|-------|-----|
| Defined | 0 | 8000 | 1 | 5 | **0.15** | 0.7 |
| Arp/Pluck | 12 | 12000 | 2 | 20 | **0.05** | 0.6 |
